<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Monitoreo IoT</title>
  <!-- Bootstrap core CSS-->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom fonts for this template-->
  <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <!-- Page level plugin CSS-->
  <link href="vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">
  <!-- Custom styles for this template-->
  <link href="css/sb-admin.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-more.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  
  <script src="mqttws31.js" type="text/javascript"></script>
  <!--<script src="jquery.min.js" type="text/javascript"></script>-->
  <script src="config.js" type="text/javascript"></script>



</head>

<body class="fixed-nav sticky-footer bg-dark" id="page-top">
  <!-- Navigation-->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
    <a class="navbar-brand" href="index.html">Sistema de monitoreo IoT de EcoCasa</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav navbar-sidenav" id="exampleAccordion">

       <li class="nav-item" data-toggle="tooltip" data-placement="right" title="Monitoreo">
          <a class="nav-link nav-link-collapse collapsed" data-toggle="collapse" href="#collapseMonitoreo" data-parent="#exampleAccordion">
            <i class="fa fa-fw fa-dashboard"></i>
            <span class="nav-link-text">Monitero</span>
          </a>
          <ul class="sidenav-second-level collapse" id="collapseMonitoreo">
            <li>
              <a href="index.html">Temperatura/humedad</a>
            </li>
            <li>
              <a href="panel.html">Panel Solar</a>
            </li>
            <li>
              <a href="aero.html">Aerogenerador</a>
            </li>
            <li>
              <a href="consumo.html">Consumo</a>
            </li>
            <li>
              <a href="bateria.html">Bateria</a>
            </li>
            <li>
              <a href="ilumina.html">Iluminación</a>
            </li>
          </ul>
        </li>
        <li class="nav-item" data-toggle="tooltip" data-placement="right" title="Historial">
          <a class="nav-link nav-link-collapse collapsed" data-toggle="collapse" href="#collapseHistorial" data-parent="#exampleAccordion">
            <i class="fa fa-fw fa-area-chart"></i>
            <span class="nav-link-text">Historial</span>
          </a>
          <ul class="sidenav-second-level collapse" id="collapseHistorial">
            <li>
              <a href="historialTemp.php">Temperatura/humedad</a>
            </li>
            <li>
              <a href="historialPanel.php">Panel Solar</a>
            </li>
            <li>
              <a href="historialAero.php">Aerogenerador</a>
            </li>
            <li>
              <a href="historialConsumo.php">Consumo</a>
            </li>
            <li>
              <a href="historialBateria.php">Batería</a>
            </li>
            <li>
              <a href="historialLux.php">Iluminación</a>
            </li>
            <li>
              <a href="historialRad.php">Radiación</a>
            </li>
          </ul>
        </li>


        <li class="nav-item" data-toggle="tooltip" data-placement="right" title="Tables">
          <a class="nav-link" href="exportar.html">
            <i class="fa fa-fw fa-table"></i>
            <span class="nav-link-text">Exportar</span>
          </a>
        </li>
       
          </ul>
        </li>
      </ul>
      <ul class="navbar-nav sidenav-toggler">
        <li class="nav-item">
          <a class="nav-link text-center" id="sidenavToggler">
            <i class="fa fa-fw fa-angle-left"></i>
          </a>
        </li>
      </ul>
      
    </div>
  </nav>
  <div class="content-wrapper">
    <div class="container-fluid">
      <!-- Breadcrumbs-->
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="#">Dashboard</a>
        </li>
        <li class="breadcrumb-item active">Monitoreo</li>
      </ol>
  
      <!-- Temp y hum-->
      <div class="card mb-3">
        <div class="card-header">
          <i class="fa fa-tachometer"></i> Iluminacion</div>
        <div class="card-body">
          
          <div id="container" style="min-width: 310px; max-width: 400px; height: 300px; margin: 0 auto"></div>

          </div>
        </div>
      </div>
     
    

    <!-- 
<div>
          <ul id='ws' style="font-family: 'Courier New', Courier, monospace;"></ul>
      </div>
    -->
    
    <footer class="sticky-footer">
      <div class="container">
        <div class="text-center">
          <small>Copyright © Emanuel Murillo 2018</small>
        </div>
      </div>
    </footer>
    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fa fa-angle-up"></i>
    </a>
    <!-- Logout Modal-->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">¿Cerrar sesión?</h5>
            <button class="close" type="button" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">×</span>
            </button>
          </div>
          <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
            <a class="btn btn-primary" href="login.html">Logout</a>
          </div>

        </div>
      </div>
    </div>
    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
    <!-- Page level plugin JavaScript-->
   
    <script src="vendor/datatables/jquery.dataTables.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.js"></script>
    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin.min.js"></script>
    <!-- Custom scripts for this page-->
    <script src="js/sb-admin-datatables.min.js"></script>
 
      
    <script type="text/javascript">
      var mqtt;
    var reconnectTimeout = 2000;
    usuario2 = 'esp2';
    usuario3 = 'esp3';
    temperaturas1 = 1;
    humedades1 = 1;
    temperaturas2 = 1;
    humedades2 = 1;

    function MQTTconnect() {
    if (typeof path == "undefined") {
        path = '/mqtt';
    }
    mqtt = new Paho.MQTT.Client(
            host,
            port,
            path,
            "web_" + parseInt(Math.random() * 100, 10)
    );
        var options = {
            timeout: 3,
            useSSL: useTLS,
            cleanSession: cleansession,
            onSuccess: onConnect,
            onFailure: function (message) {
                $('#status').val("Connection failed: " + message.errorMessage + "Retrying");
                setTimeout(MQTTconnect, reconnectTimeout);
            }
        };

        mqtt.onConnectionLost = onConnectionLost;
        mqtt.onMessageArrived = onMessageArrived;

        if (username != null) {
            options.userName = username;
            options.password = password;
        }
        console.log("Host="+ host + ", port=" + port + ", path=" + path + " TLS = " + useTLS + " username=" + username + " password=" + password);
        mqtt.connect(options);
    }

    function onConnect() {
        $('#status').val('Connected to ' + host + ':' + port + path);
        // Connection succeeded; subscribe to our topic
        mqtt.subscribe(topic, {qos: 0});
        $('#topic').val(topic);

           web = new Paho.MQTT.Message("T");
           web.destinationName = '/esp2/request'
           mqtt.send(web); 
           web2 = new Paho.MQTT.Message("T");
           web2.destinationName = '/esp3/request'
           mqtt.send(web2);
    }

    function onConnectionLost(response) {
        setTimeout(MQTTconnect, reconnectTimeout);
        $('#status').val("connection lost: " + responseObject.errorMessage + ". Reconnecting");
    };


    function onMessageArrived(message) {

        
        if (message.destinationName == '/' + usuario2 + '/' + 'temp') { //acá coloco el topic
            //document.getElementById("temperatura1").textContent = message.payloadString  + " ºC";
            //chartTemp1.refesh(message.payloadString);
            temperaturas1 = Math.round(parseFloat(message.payloadString));
        }
        if (message.destinationName == '/' + usuario2 + '/' + 'hum') { //acá coloco el topic
            //document.getElementById("humedad1").textContent = message.payloadString + " %";
             humedades1 = parseFloat(message.payloadString);
             web = new Paho.MQTT.Message("T");
             web.destinationName = '/esp2/request'
             mqtt.send(web);
        }
       if (message.destinationName == '/' + usuario3 + '/' + 'temp') { //acá coloco el topic
            //document.getElementById("temperatura2").textContent = message.payloadString  + " ºC";
             temperaturas2 = Math.round(parseFloat(message.payloadString));
        }
        if (message.destinationName == '/' + usuario3 + '/' + 'hum') { //acá coloco el topic
            //document.getElementById("humedad2").textContent = message.payloadString + " %";
            humedades2 = parseFloat(message.payloadString);
             web = new Paho.MQTT.Message("T");
             web.destinationName = '/esp3/request'
             mqtt.send(web);
        }

            
    };



    $(document).ready(function() {
        MQTTconnect();




    });

    Highcharts.chart('container', {

        chart: {
            type: 'gauge',
            plotBackgroundColor: null,
            plotBackgroundImage: null,
            plotBorderWidth: 0,
            plotShadow: false
        },

        title: {
            text: 'Luxómetro'
        },

        pane: {
            startAngle: -150,
            endAngle: 150,
            background: [{
                backgroundColor: {
                    linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                    stops: [
                        [0, '#FFF'],
                        [1, '#333']
                    ]
                },
                borderWidth: 0,
                outerRadius: '109%'
            }, {
                backgroundColor: {
                    linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1 },
                    stops: [
                        [0, '#333'],
                        [1, '#FFF']
                    ]
                },
                borderWidth: 1,
                outerRadius: '107%'
            }, {
                // default background
            }, {
                backgroundColor: '#DDD',
                borderWidth: 0,
                outerRadius: '105%',
                innerRadius: '103%'
            }]
        },

        // the value axis
        yAxis: {
            min: 0,
            max: 200,

            minorTickInterval: 'auto',
            minorTickWidth: 1,
            minorTickLength: 10,
            minorTickPosition: 'inside',
            minorTickColor: '#666',

            tickPixelInterval: 30,
            tickWidth: 2,
            tickPosition: 'inside',
            tickLength: 10,
            tickColor: '#666',
            labels: {
                step: 2,
                rotation: 'auto'
            },
            title: {
                text: 'Lux'
            },
            plotBands: [{
                from: 0,
                to: 120,
                color: '#55BF3B' // green
            }, {
                from: 120,
                to: 160,
                color: '#DDDF0D' // yellow
            }, {
                from: 160,
                to: 200,
                color: '#DF5353' // red
            }]
        },

        series: [{
            name: 'Speed',
            data: [80],
            tooltip: {
                valueSuffix: ' km/h'
            }
        }]

    },
    // Add some life
    function (chart) {
        if (!chart.renderer.forExport) {
            setInterval(function () {
                var point = chart.series[0].points[0],
                    newVal,
                    inc = Math.round((Math.random() - 0.5) * 20);

                newVal = point.y + inc;
                if (newVal < 0 || newVal > 200) {
                    newVal = point.y - inc;
                }

                point.update(newVal);

            }, 3000);
        }
    });
   


 </script>

 </div>
</body>

</html>
